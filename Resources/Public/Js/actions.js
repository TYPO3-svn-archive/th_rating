/*! * Javascript Library for TYPO3 extension th_rating * version: 1.04 (08-SEPT-2013) * @requires jQuery v1.3.2 or later * @requires jQuery Form Plugin 2.47 or later * *  Copyright notice**  (c) 2013 Thomas Hucke <thucke@web.de> *  All rights reserved**  This script is part of the TYPO3 project. The TYPO3 project is*  free software; you can redistribute it and/or modify*  it under the terms of the GNU General Public License as published by*  the Free Software Foundation; either version 2 of the License, or*  (at your option) any later version.**  The GNU General Public License can be found at*  http://www.gnu.org/copyleft/gpl.html.**  This script is distributed in the hope that it will be useful,*  but WITHOUT ANY WARRANTY; without even the implied warranty of*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the*  GNU General Public License for more details.**  This copyright notice MUST APPEAR in all copies of the script!***************************************************************//** * Constructor * * This initializes the all event listeners */jQuery(document).ready(function() {	jQuery('#vote').ajaxForm({		beforeSubmit:  	checkVoteSubmission,  // pre-submit callback 		success:    	handleReceivedVote  // post-submit callback 	}); 	jQuery('a.ajaxLink').click( function() {		submitVoteForm(jQuery.parseJSON(jQuery('input:first-child',this).val()));		return false;	});		//handle all changes of selection inputs	jQuery('select.ajaxLink').change( function() {		//value is like '{"value":2,"voter":1,"rating":2,"ajaxRef":3599914}'		submitVoteForm(jQuery.parseJSON(this.value));		return false;	});	jQuery('.tx-thrating-flash-message').each(fadeFlashMessage);});/** * Form submission * * ... being called by multiple event handlers */function submitVoteForm( choosenValue ) {		var targetFormElements = document.forms["vote"].elements;		targetFormElements["tx_thrating_pi1[__referrer][actionName]"].value = choosenValue.actionName;		targetFormElements["tx_thrating_pi1[vote][vote]"].value = choosenValue.value;		targetFormElements["tx_thrating_pi1[vote][voter]"].value = choosenValue.voter;		targetFormElements["tx_thrating_pi1[vote][rating]"].value = choosenValue.rating;		targetFormElements["tx_thrating_pi1[settings]"].value = choosenValue.settings;		targetFormElements["tx_thrating_pi1[ajaxRef]"].value = choosenValue.ajaxRef;		jQuery('#vote').submit();}/** * jQuery pre-submit callback */function checkVoteSubmission(formData, jqForm, options) { 	for (var i = 0; i < formData.length; ++i) {		if (formData[i]["name"] == "tx_thrating_pi1[vote][vote]" && formData[i]["value"] == 0) {			//alert("Choose a valid rating");			// return false to prevent the form from being submitted; 			return false;		}		if (formData[i]["name"] == "tx_thrating_pi1[ajaxRef]") {			var ajaxTargetId = 'tx-thrating-pi1-' + formData[i]["value"];		}	}	var targetObj = document.getElementById(ajaxTargetId);	jQuery(targetObj).addClass("loading")					 .fadeTo(500,0.01);	return true; } 		/** * jQuery post-submit callback * * The returned content will only be replaced if voteform or ratinglink is returned. * Possibly returned flash messages are copied into the right content element DIV. */function handleReceivedVote(responseText, statusText, xhr, $form)  { 	for (var i = 0; i < $form[0].length; ++i) {		//$form[0] is the array of vote sumbissions		if ($form[0][i]["name"] == "tx_thrating_pi1[ajaxRef]") {			var ajaxTargetId = 'tx-thrating-pi1-' + $form[0][i]["value"];			break;		}	}	var doReplace = true;	var response = jQuery(responseText);	flashMessages = jQuery('.tx-thrating-flash-message',response).html(); //save flash-messages-DIV in Var	var targetObj = document.getElementById(ajaxTargetId);	//do not replace content if vote request was invalid	if (doReplace) {		jQuery(targetObj).fadeTo(1,0.01,function() {			jQuery('.tx-thrating-content',this)				.replaceWith( response )				.removeClass("loading")				.fadeTo(500,1);							//Re-register event handlers			jQuery('a.ajaxLink',this).click( function() {				submitVoteForm(jQuery.parseJSON(jQuery('input:first-child',this).val()));				return false;			});			jQuery('select.ajaxLink').change( function() {				//value is like '{"value":2,"voter":1,"rating":2,"ratingName":"stars","ajaxRef":3599914}'				submitVoteForm(jQuery.parseJSON(this.value));				return false;			});					});		jQuery('#dummy4focus').focus(); // remove focus from ratinglinks		jQuery('div#'+ajaxTargetId+' select.ajaxLink').attr('selectedIndex',0); //reset selection box	} else {		jQuery(targetObj).fadeTo(1,0.01);			}	jQuery().delay(5000);	jQuery('.tx-thrating-flash-message',targetObj)		.html(flashMessages)		.each(fadeFlashMessage);	jQuery(targetObj)			.removeClass("loading")			.fadeTo(500,1);	//alert(jQuery(document.getElementById(ajaxTargetId)).html());}/** * FlashMessages Fadein / Fadeout * * ... being called when AJAX response contains flash messages */function fadeFlashMessage() {	if ( jQuery(this).children().first().html() != null ) {		jQuery(this).fadeTo(1500,0.9,function() {			jQuery(this)				.delay(1500)				.fadeOut(1500)		});	}}