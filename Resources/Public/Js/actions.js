/*! * Javascript Library for TYPO3 extension th_rating * version: 1.05 (29-Jan-2014) * @requires jQuery v1.3.2 or later * @requires jQuery Form Plugin 2.47 or later * *  Copyright notice**  (c) 2014 Thomas Hucke <thucke@web.de> *  All rights reserved**  This script is part of the TYPO3 project. The TYPO3 project is*  free software; you can redistribute it and/or modify*  it under the terms of the GNU General Public License as published by*  the Free Software Foundation; either version 2 of the License, or*  (at your option) any later version.**  The GNU General Public License can be found at*  http://www.gnu.org/copyleft/gpl.html.**  This script is distributed in the hope that it will be useful,*  but WITHOUT ANY WARRANTY; without even the implied warranty of*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the*  GNU General Public License for more details.**  This copyright notice MUST APPEAR in all copies of the script!***************************************************************//** * Constructor */jQuery(document).ready(function() {	initBinding();	jQuery('#vote').ajaxForm({		beforeSubmit:  	checkVoteSubmission,  // pre-submit callback		success:		handleReceivedVote  // post-submit callback 	});	jQuery('.tx-thrating-flash-message').each(fadeFlashMessage);                });/** * Initialize all event listeners */function initBinding() {	jQuery('span.ajaxLink').hover( function() {  { switchStepname(this,true); } }, function() {  { switchStepname(this,false); } });	jQuery('span.ajaxLink').one('click', function() {		submitVoteForm(jQuery.parseJSON(jQuery('input:first-child',this).val()));		return false;	});		//handle all changes of selection inputs	jQuery('select.ajaxLink').attr("disabled", false);    	jQuery('select.ajaxLink').change( function() {		//value is like '{"value":2,"voter":1,"rating":2,"ajaxRef":3599914}'		submitVoteForm(jQuery.parseJSON(this.value));		return false;	});    }/** * Form submission * * ... being called by multiple event handlers */function submitVoteForm( choosenValue ) {		var targetFormElements = document.forms["vote"].elements;		targetFormElements["tx_thrating_pi1[__referrer][@action]"].value = choosenValue.actionName;		targetFormElements["tx_thrating_pi1[vote][vote]"].value = choosenValue.value;		targetFormElements["tx_thrating_pi1[vote][voter]"].value = choosenValue.voter;		targetFormElements["tx_thrating_pi1[vote][rating]"].value = choosenValue.rating;		targetFormElements["tx_thrating_pi1[settings]"].value = choosenValue.settings;		targetFormElements["tx_thrating_pi1[ajaxRef]"].value = choosenValue.ajaxRef;		jQuery('#vote').submit();}/** * jQuery pre-submit callback */function checkVoteSubmission(formData, jqForm, options) { 	for (var i = 0; i < formData.length; ++i) {		if (formData[i]["name"] == "tx_thrating_pi1[vote][vote]" && formData[i]["value"] == 0) {			//alert("Choose a valid rating");			initBinding();			// return false to prevent the form from being submitted; 			return false;		}		if (formData[i]["name"] == "tx_thrating_pi1[ajaxRef]") {			var ajaxTargetId = 'tx-thrating-pi1-' + formData[i]["value"];		}	}	var targetObj = document.getElementById(ajaxTargetId);	jQuery(targetObj).addClass("loading")					 .fadeTo(400,0.01);	return true; } 		/** * jQuery post-submit callback * * The returned content will only be replaced if voteform or ratinglink is returned. * Possibly returned flash messages are copied into the right content element DIV. */function handleReceivedVote(responseText, statusText, xhr, $form)  { 	var doReplace = true;	var response = jQuery(responseText);	var ajaxTargetId = jQuery(response).attr('id');	content = jQuery('.tx-thrating-content',response).html(); //save conent-DIV in Var	flashMessages = jQuery('.tx-thrating-flash-message',response).html(); //save flash-messages-DIV in Var	var targetObj = document.getElementById(ajaxTargetId);	//do not replace content if vote request was invalid	if (doReplace) {		jQuery(targetObj).fadeTo(1,0.01,function() {			jQuery('.tx-thrating-content',this)				.empty()				.append( content )				.removeClass("loading")				.fadeTo(200,1);			initBinding();		});		jQuery('#dummy4focus').focus(); // remove focus from ratinglinks		jQuery('div#'+ajaxTargetId+' select.ajaxLink').attr('selectedIndex',0); //reset selection box	} else {		jQuery(targetObj).fadeTo(1,0.01);		initBinding();	}	jQuery(targetObj)			.removeClass("loading")			.fadeTo(200,1);	//replace flashmessages of this rating	jQuery('.tx-thrating-flash-message',targetObj)		.delay(200)		.html(flashMessages)		.each(fadeFlashMessage);}/** * FlashMessages Fadein / Fadeout */function fadeFlashMessage() {	if ( jQuery(this).children().first().html() != null ) {		jQuery(this).fadeTo(800,0.9,function() {			jQuery(this)				.delay(1500)				.fadeOut(1000)		});	}}/** * Switch stepname visibility */function switchStepname( linkObj, hoverIn ) {	stepname = jQuery(linkObj).attr('title');	stepnameObj = jQuery(linkObj).parents('div.tx-thrating-ratinglinks').children('div#stepname').first();	if ( hoverIn ) {		jQuery(stepnameObj).html(stepname).addClass('stepname');	} else {		jQuery(stepnameObj).html('&nbsp;').removeClass('stepname');    	}}